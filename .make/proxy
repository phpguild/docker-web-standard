.PHONY: proxy/install proxy/restart

proxy/install:
ifeq (sudo, $(SUDO))
ifeq ("$(wildcard /etc/nginx/sites-enabled/$(APP_NAME).$(APP_INSTANCE).conf)","")
ifeq (dev, $(APP_ENV))
	$(SUDO) sh -c "grep -q -F '127.0.0.1 $(APP_NAME).local.test' /etc/hosts || echo '127.0.0.1 $(APP_NAME).local.test' >> /etc/hosts"
	$(SUDO) sh -c "grep -q -F '127.0.0.1 $(APP_NAME).test' /etc/hosts || echo '127.0.0.1 $(APP_NAME).test' >> /etc/hosts"
endif
	$(SUDO) mkdir -p /etc/nginx/sites-enabled
ifeq ("$(wildcard /etc/nginx/nginx.conf.save)","")
	$(SUDO) cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.save
	$(SUDO) cp $(shell pwd)/config/nginx/nginx.conf /etc/nginx/nginx.conf
endif
	$(SUDO) ln -s "$(shell pwd)/config/nginx/proxies/$(APP_INSTANCE).conf" "/etc/nginx/sites-enabled/$(APP_NAME).$(APP_INSTANCE).conf"
endif
endif

proxy/restart:
ifeq (sudo, $(SUDO))
	$(SUDO) nginx -t
	$(SUDO) service nginx restart
endif
